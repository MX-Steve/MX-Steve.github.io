var app=angular.module("ktz",["ng","ngRoute","ngAnimate"]);app.factory("$debounce",["$rootScope","$browser","$q","$exceptionHandler",function(b,a,e,f){var h={},d={},g=0;function c(p,m,n){var r=e.defer(),s=r.promise,k=(angular.isDefined(n)&&!n),q,i,o,j=false;angular.forEach(d,function(u,t){if(angular.equals(d[t].fn,p)){j=true;o=t}});if(!j){o=g++;d[o]={fn:p}}else{h[d[o].timeoutId].reject("bounced");a.defer.cancel(d[o].timeoutId)}var l=function(){delete d[o];try{r.resolve(p())}catch(t){r.reject(t);f(t)}if(!k){b.$apply()}};q=a.defer(l,m);d[o].timeoutId=q;i=function(t){delete h[s.$$timeoutId]};s.$$timeoutId=q;h[q]=r;s.then(i,i);return s}c.cancel=function(i){if(i&&i.$$timeoutId in h){h[i.$$timeoutId].reject("canceled");return a.defer.cancel(i.$$timeoutId)}return false};return c}]);app.config(function(a){a.when("/ktzStart",{templateUrl:"tpl/start.html"}).when("/ktzLogin",{templateUrl:"tpl/login.html",controller:"loginCtrl"}).when("/ktzRegister",{templateUrl:"tpl/register.html",controller:"registerCtrl"}).when("/ktzMain",{templateUrl:"tpl/main.html",controller:"mainCtrl"}).when("/ktzDetail/:kid",{templateUrl:"tpl/detail.html",controller:"detailCtrl"}).when("/ktzPay/:kid",{templateUrl:"tpl/pay.html",controller:"payCtrl"}).when("/ktzPersonal",{templateUrl:"tpl/personal.html",controller:"personalCtrl"}).when("/ktzFind",{templateUrl:"tpl/find.html"}).otherwise({redirectTo:"/ktzStart"})});app.controller("parentCtrl",["$scope","$location",function(a,b){a.jump=function(c){b.path(c)}}]);app.controller("mainCtrl",["$scope","$http","$debounce",function(a,c,b){a.hasMore=true;c.get("data/kind_getbypage.php").success(function(d){a.kindList=d});a.loadMore=function(){c.get("data/kind_getbypage.php?start="+a.kindList.length).success(function(d){if(d.length<5){a.hasMore=false}a.kindList=a.kindList.concat(d)})};a.$watch("kw",function(){b(watchHandler,500)});watchHandler=function(){if(a.kw){c.get("data/kind_getbykw.php?kw="+a.kw).success(function(d){a.kindList=d})}}}]);app.controller("detailCtrl",["$scope","$routeParams","$http",function(a,b,c){c.get("data/kind_getbyid.php?id="+b.kid).success(function(d){a.kind=d[0]})}]);app.controller("payCtrl",["$scope","$routeParams","$http",function(a,b,c){console.log(b);c.get("data/kind_getbyid.php?id="+b.kid).success(function(d){if(d.length>0){a.kind=d[0]}});a.submitOrder=function(){console.log(b.kid);a.oid=localStorage.getItem("oid");c.get("data/class_add.php?kid="+b.kid+"&oid="+a.oid).success(function(d){a.result=d[0];console.log(a.result);if(d.length>0){if(a.result.msg=="succ"){a.succMsg="添加课程成功，订单编号为"+a.result.oid}else{a.errMsg="添加课程失败!"}}})}}]);app.controller("registerCtrl",["$scope","$httpParamSerializerJQLike","$http","$location",function(a,b,d,c){a.reg={};a.loginUser=function(){a.result=b(a.reg);console.log(a.result);d.get("data/user_register.php?"+a.result).success(function(e){console.log(e);localStorage.setItem("phone",a.reg.phone);localStorage.setItem("oid",e[0].oid)});c.path("/ktzLogin")}}]);app.controller("personalCtrl",["$scope","$http",function(a,b){a.phone=localStorage.getItem("phone");a.oid=localStorage.getItem("oid");console.log(a.phone);console.log(a.oid);b.get("data/myclass.php?phone="+a.phone).success(function(c){console.log(c);a.orderList=c})}]);app.controller("loginCtrl",["$scope","$http","$location",function(a,c,b){a.loginClick=function(){c.get("data/user_login.php?name="+a.name+"&pwd="+a.pwd).success(function(d){console.log(d);if(d.msg=="succ"){b.path("/ktzMain")}else{}})}}]);